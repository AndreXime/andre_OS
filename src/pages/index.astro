---
import Layout from "../layout/Layout.astro";
import Header from "../components/layout/Header.astro";
import Footer from "../components/layout/Footer.astro";
import Sidebar from "../components/layout/Sidebar.astro";
import PreviewCard from "@/components/ui/PreviewCards";
import { getCollection, getEntry } from "astro:content";

export const prerender = false;

const { searchParams } = Astro.url;
const categoryParam = searchParams.get("category") || "all";
const searchParam = searchParams.get("q") || "";

const posts = (await getCollection("posts")).map(({ data, ...post }) => data);

const metaEntry = await getEntry("meta", "global");
const tags = metaEntry?.data.tags || {};
const lastDate = metaEntry?.data.lastDate || undefined;

const filteredPosts = posts.filter((post) => {
	const data = post;

	// Filtro de Categoria
	if (categoryParam !== "all" && data.type !== categoryParam) return false;

	// Filtro de Texto
	if (searchParam) {
		return (
			data.title.toLowerCase().includes(searchParam) ||
			data.description.toLowerCase().includes(searchParam) ||
			data.tags.some((t) => t.toLowerCase().includes(searchParam))
		);
	}
	return true;
});

Astro.response.headers.set(
	"Cache-Control",
	"public, max-age=0, s-maxage=31536000, must-revalidate",
);
---

<Layout title="andre_OS">
	<div class="min-h-screen relative">
		<Header searchParam={searchParam} filterParam={categoryParam} />

		<div
			class="pt-20 px-4 md:px-6 max-w-[1600px] mx-auto grid grid-cols-1 lg:grid-cols-12 gap-8 transition-all"
		>
			<Sidebar
				tagCounts={tags}
				currentFilter={categoryParam}
				currentSearch={searchParam}
			/>

			<main class={`flex lg:col-span-10`}>
				<div
					class="grid gap-4 grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 auto-rows-min w-full"
				>
					{
						filteredPosts && filteredPosts.length > 0 ? (
							filteredPosts.map((item) => {
								let itemUrl = "";

								switch (item.type) {
									case "note":
										itemUrl = `/post/${item.slug}`;
										break;

									case "link":
										itemUrl = `${item.url}`;
										break;

									case "tool":
										itemUrl = `/app/${item.tool_name}`;
										break;
									default:
										itemUrl = "";
										break;
								}

								return (
									<a
										href={itemUrl}
										{...(item.type === "link"
											? {
													target: "_blank",
													rel: "noopener noreferrer",
												}
											: {})}
										class={`block group h-full relative ${item.featured ? "md:col-span-2" : "col-span-1"} outline-none focus-visible:ring-2 ring-emerald-500/50 rounded-md`}
									>
										<PreviewCard post={item} />
									</a>
								);
							})
						) : (
							<div class="col-span-full py-20 text-center border border-dashed border-zinc-800 rounded-lg ">
								{searchParam ? (
									<>
										<p class="text-zinc-500 text-lg">
											Nenhum resultado encontrado para
											{`"${searchParam}"`}.
										</p>
										<a
											href="/"
											class="mt-4 inline-block text-emerald-500 hover:underline"
										>
											Limpar filtros
										</a>
									</>
								) : (
									<div class="col-span-full py-20 text-center border border-dashed border-zinc-800 rounded-lg ">
										<p class="text-zinc-500 text-lg">
											Por enquanto n√£o foi publicado
											nenhum post
										</p>
									</div>
								)}
							</div>
						)
					}
				</div>
			</main>
		</div>

		<Footer lastDate={lastDate} />
	</div>
</Layout>
